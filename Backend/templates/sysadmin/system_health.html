{% extends 'base.html' %}
{% block title %}System Health{% endblock %}

{% block extra_css %}
<style>
  .lights-container {
    display: flex; /* Flexbox layout for health check lights */
    flex-wrap: wrap; /* Allow wrapping of lights */
    justify-content: space-around; /* Space lights evenly */
    align-items: flex-start; /* Align lights to the top */
    gap: 2rem; /* Space between lights */
    padding: 2rem; /* Padding around lights container */
  }
  .light-item {
    display: flex; /* Flexbox layout for light items */
    flex-direction: column; /* Stack light and text vertically */
    align-items: center; /* Centre items horizontally */
    width: 120px; /* Fixed width for light items */
  }
  .light-dot {
    width: 80px; /* Width for light dot */
    height: 80px; /* Height for light dot */
    border-radius: 50%; /* Rounded shape for light dot */
    background: gray; /* Default background colour for light dot */
    margin-bottom: 1rem; /* Space below light dot */
    transition: background 0.3s, box-shadow 0.3s; /* Transition effects for light dot */
  }
  .light-dot.green {
    background: #28a745; /* Green background for healthy status */
    box-shadow: 0 0 20px rgba(40,167,69,0.7); /* Shadow effect for healthy status */
  }
  .light-dot.red {
    background: #dc3545; /* Red background for unhealthy status */
    box-shadow: 0 0 20px rgba(220,53,69,0.7); /* Shadow effect for unhealthy status */
  }
  .container-name {
    font-weight: bold; /* Bold font for container name */
    text-align: center; /* Centre text */
    margin-bottom: 0.3rem; /* Space below container name */
  }
  .container-status {
    text-transform: capitalize; /* Capitalise status text */
    font-size: 0.9rem; /* Font size for status text */
    color: #555; /* Colour for status text */
  }
  #error {
    color: #dc3545; /* Red colour for error message */
    text-align: center; /* Centre error message */
    margin-bottom: 1rem; /* Space below error message */
  }
</style>
{% endblock %}

{% block content %}
  <h1>System Health</h1> <!-- Main title for system health page -->
  <div id="error" hidden>Unable to fetch health checks.</div> <!-- Error message for health checks -->
  <div id="list" class="lights-container"> <!-- Container for health check lights -->
    {# JS will inject the check lights here #} <!-- Placeholder for health check lights -->
  </div>
{% endblock %}

{% block extra_js %}
<script>

  const HEALTH_URL = 'api/?format=json'; // URL for health check API

  // Map raw check titles to friendly names:
  const DISPLAY_MAP = {
    'Cache backend: default':    'Cache', // Friendly name for cache check
    'DatabaseBackend':           'Database', // Friendly name for database check
    'DefaultFileStorageHealthCheck': 'File Storage' // Friendly name for file storage check
  };

  async function fetchStatus() {
    try {
      const res = await fetch(HEALTH_URL, { credentials: 'same-origin' }); // Fetch health check data
      if (!res.ok) throw new Error('Non-200 status ' + res.status); // Handle non-200 responses

      document.getElementById('error').hidden = true; // Hide error message
      const data = await res.json(); // Parse response as JSON

      // Normalize into an array of { title, ok }:
      let checksArr;
      if (Array.isArray(data.checks)) {
        checksArr = data.checks.map(c => ({
          title: c.title || c.id, // Get title or ID for each check
          ok: !!c.ok // Convert status to boolean
        }));
      } else {
        checksArr = Object.entries(data).map(([key, status]) => ({
          title: key, // Get title from key
          ok: status === true || status === 'working' || status === 'OK' // Convert status to boolean
        }));
      }

      renderLights(checksArr); // Render health check lights
    } catch (err) {
      document.getElementById('error').hidden = false; // Show error message
      console.error('Health-check fetch failed:', err); // Log error to console
    }
  }

  function renderLights(items) {
    const list = document.getElementById('list'); // Reference to lights container
    list.innerHTML = ''; // Clear previous lights

    if (items.length === 0) {
      list.innerHTML = `
        <div class="light-item">
          <div class="light-dot red"></div> <!-- Red light for no checks -->
          <div class="container-name">No Checks</div> <!-- Name for no checks -->
          <div class="container-status">down</div> <!-- Status for no checks -->
        </div>`;
      return; // Exit function if no checks
    }

    items.forEach(c => {
      const cls = c.ok ? 'green' : 'red'; // Determine class based on status
      const statusText = c.ok ? 'Healthy' : 'Down'; // Determine status text
      // Apply friendly name, or fall back to raw title
      const displayName = DISPLAY_MAP[c.title] || c.title; // Get display name

      const item = document.createElement('div'); // Create light item
      item.className = 'light-item'; // Set class for light item
      item.innerHTML = `
        <div class="light-dot ${cls}"></div> <!-- Light dot -->
        <div class="container-name">${displayName}</div> <!-- Display name -->
        <div class="container-status">${statusText}</div> <!-- Display status -->
      `;
      list.appendChild(item); // Append light item to list
    });
  }

  // Initial load + poll every 30s
  fetchStatus(); // Fetch health status on load
  setInterval(fetchStatus, 30000); // Poll health status every 30 seconds
</script>
{% endblock %}