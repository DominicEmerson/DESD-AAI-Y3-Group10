{% extends 'base.html' %}
{% block title %}System Health{% endblock %}

{% block extra_css %}
<style>
  .lights-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 2rem;
  }
  .light-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .light-dot {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: gray;
    margin-bottom: 1rem;
    transition: background 0.3s, box-shadow 0.3s;
  }
  .light-dot.green {
    background: #28a745;
    box-shadow: 0 0 20px rgba(40,167,69,0.7);
  }
  .light-dot.yellow {
    background: #ffc107;
    box-shadow: 0 0 20px rgba(255,193,7,0.7);
  }
  .light-dot.red {
    background: #dc3545;
    box-shadow: 0 0 20px rgba(220,53,69,0.7);
  }
  .container-name {
    font-weight: bold;
    margin-bottom: 0.3rem;
  }
  .container-status {
    text-transform: capitalize;
    font-size: 0.9rem;
    color: #555;
  }
  #error {
    color: #dc3545;
    text-align: center;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
  <h1>System Health</h1>
  <div id="error" hidden>Unable to fetch container status.</div>
  <div id="list" class="lights-container">
    {# JS will inject .light-item blocks here #}
  </div>
{% endblock %}

{% block extra_js %}
<script>
const NAME_MAP = {
  'desd-aai-y3-group10-postgres_db-1': 'Database',
  'desd-aai-y3-group10-django_app-1':  'Webapp',
  'desd-aai-y3-group10-mlaas-1':       'Prediction System',
};

  async function fetchStatus() {
    try {
      const res = await fetch("{% url 'container_status_api' %}");
      if (!res.ok) throw new Error();
      document.getElementById('error').hidden = true;
      const data = await res.json();
      renderLights(data);
    } catch (err) {
      document.getElementById('error').hidden = false;
      console.error(err);
    }
  }

  function renderLights(containers) {
    const list = document.getElementById('list');
    list.innerHTML = '';

    containers.forEach(c => {
      // Determine display name
      let display = NAME_MAP[c.name] || c.name;

      // Status logic
      let cls = 'red', statusText = 'down';
      if (c.state === 'running') {
        if (c.health === 'unhealthy') {
          cls = 'yellow';
          statusText = 'unhealthy';
        } else {
          cls = 'green';
          statusText = 'healthy';
        }
      }

      // Build the element
      const item = document.createElement('div');
      item.className = 'light-item';
      item.innerHTML = `
        <div class="light-dot ${cls}"></div>
        <div class="container-name">${display}</div>
        <div class="container-status">${statusText}</div>
      `;
      list.appendChild(item);
    });
  }

  // initial load + poll every 30s
  fetchStatus();
  setInterval(fetchStatus, 30000);
</script>
{% endblock %}
